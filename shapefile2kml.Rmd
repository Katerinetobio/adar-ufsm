---
title: "Geração KML a partir de *shapefile* da [ANA](http://www.ana.gov.br/)"
output:
  html_document: 
    keep_md: yes
  html_notebook: default
---

```{r, echo = FALSE}
knitr::opts_chunk$set(comment = "", message = FALSE)
```


# Introdução 

A Agência Nacional das Águas ([ANA](http://www.ana.gov.br/)) disponibiliza um banco de informações hidrológicas para as regiões hidrográficas brasileiras através do site [hidroweb](http://hidroweb.ana.gov.br/HidroWeb.asp?TocItem=4100)[^1]. As informações são fornecidas no formato [shapefile](https://en.wikipedia.org/wiki/Shapefile) (extensão `.shp`). Na verdade, um *shapefile* está associado a um conjunto de arquivos (no mínimo 3). Os dados são divididos por [regiões hidrográficas](https://pt.wikipedia.org/wiki/Regi%C3%B5es_hidrogr%C3%A1ficas_do_Brasil). 

Nesse tutorial veremos como converter o conjunto de arquivos associados a um *shapefile* da hidrografia da região hidrográfica do Rio Uruguai (Bacia 7) para o formato [KML](https://en.wikipedia.org/wiki/Keyhole_Markup_Language) para visualização no [Google Earth](https://en.wikipedia.org/wiki/Google_Earth).

![](https://upload.wikimedia.org/wikipedia/commons/thumb/8/8c/Brasil_Bacias_hidrograficas.svg/300px-Brasil_Bacias_hidrograficas.svg.png)

# Pré-requisitos

Para converter os arquivos associados ao *shapefile* utilizaremos a função `KML()` disponibilizada com o pacote [raster](https://cran.r-project.org/web/packages/raster/index.html). Para instalar um pacote no R, digite `install.packages("raster")`.

```{r, echo=TRUE}
# carregando pacote raster para uso
library(raster)
options(stringsAsFactors = TRUE)
```


# Baixando dados

Para baixar o arquivo compactado com as informações hidrológicas de uma região hidrográfica precisamos do código identificador. No caso da região hidrográfica do Rio Uruguai o identificador é o número 7. 

```{r, echo=TRUE}
# identificador da bacia hidrográfica (BH)
id_bh <- 7
# site definido conforme nº identificador da BH
website <- "http://hidroweb.ana.gov.br/baixar/mapa/BaciaX.zip"
(website <- gsub("X", id_bh, website))
# nome e caminho para o arquivo que será baixado 
(zip_file <- paste0("data/", basename(website)))
```

```{r, eval=FALSE}
# baixand arquico compactado
download.file(website, destfile = zip_file)
```

```{r, eval=FALSE}
#d escompactando arquivo
(extract_dir <- gsub("\\.zip","",zip_file))
unzip(zip_file, exdir = extract_dir)
```

Lista dos arquivos shapefile da ANA baixados.

```{r}
shapefiles_list <- list.files("data/Bacia7",
                              pattern = "shp$", 
                              recursive = T, 
                              full.names = T)
```

```{r}
# nome do shapefile com a rede drenagem da bacia de interesse
dren_file <- grep(x = shapefiles_list, 
                    pattern = "Hidrografia 1000000", 
                    value = T)
dren_file
# importando shapefile
dren <- shapefile(dren_file)
# tabela de dados do shapefile
head(dren@data)
```


```{r}
## selecionando somente as variáveis de interesse no slot de dados 
## do objeto dren (SpatialLinesDataFrame)  
dren@data <- subset(dren@data, sel = c("NORIO", "NORIOCOMP", "COBACIA", "CORIO")) 
## definindo o a projeção dos dados (que é mesma dos ) de acordo com a do Google Earth
dren_ll <- spTransform(dren, CRSobj = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs +towgs84=0,0,0")
## gerando arquivo KML para visualização no google-earth
## salva no dir data_base_path
(kml_file <- gsub("X", id_bh, "data/drenX.kmz"))
KML(x = dren_ll, file = kml_file, overwrite = TRUE)
file.exists(kml_file)
```


# ploKML


[^1]: Para saber mais o conjunto de informações hidrológicas disponibilizadas pela ANA clique [aqui](http://www2.ana.gov.br/Paginas/servicos/informacoeshidrologicas/redehidro.aspx)


